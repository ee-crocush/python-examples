# Асинхронность

## 1. Что такое асинхронное программирование?

Асинхронное программирование — это подход, при котором код не блокирует выполнение других задач во время ожидания операций ввода/вывода (I/O). Например, запрос к базе данных или HTTP-запрос может выполняться в фоне, позволяя основной программе обрабатывать другие задачи.

Асинхронность позволяет:

- Обрабатывать множество I/O операций одновременно.
- Увеличивать производительность, особенно в I/O-bound задачах (работа с сетью, файлами, базами данных).
- Избегать блокировки потоков выполнения.

## 2. Чем отличается asyncio от потоков?

### 1. Основные отличия

| Характеристика | asyncio                                            | Потоки (Threads)                                         |
| -------------- | -------------------------------------------------- | -------------------------------------------------------- |
| Подход         | Однопоточный, использует цикл событий (event loop) | Многопоточный, каждый поток — отдельная нить выполнения  |
| I/O операции   | Неблокирующие, управляются через await/coroutines. | Блокирующие, требуют синхронизации данных между потоками |
| Ресурсы        | Легковесный (нет накладных расходов на потоки)     | Более тяжелый (контекстные переключения, память)         |
| Использование  | Идеально для I/O-bound задач                       | Подходит для CPU-bound задач                             |
| Проблемы       | Более сложное написание и отладка кода             | Возможны состояния гонки и блокировки.                   |

asyncio используется для асинхронного программирования без создания новых потоков, что делает его более производительным для задач с высоким количеством I/O.

### 2. Как работают asyncio и потоки

#### Asyncio (Асинхронность)

- asyncio использует событийный цикл для управления задачами.
- Задачи приостанавливаются в определенные моменты, явно указанные разработчиком с помощью await, что позволяет другим задачам выполняться в это время.
- Контекст переключается только тогда, когда текущая задача "ждет" чего-то (например, ответа от сети или данных с диска).
- Используется для выполнения большого количества задач ввода-вывода (например, работа с сетью, файловыми системами, базами данных).

Пример:

```python
import asyncio

async def task1():
    print("Start task1")
    await asyncio.sleep(2)  # имитация I/O
    print("End task1")

async def task2():
    print("Start task2")
    await asyncio.sleep(1)  # имитация I/O
    print("End task2")

async def main():
    await asyncio.gather(task1(), task2())

asyncio.run(main())
```

Результат:

Задачи выполняются "параллельно", хотя фактически они переключаются между собой, пока одна ждет выполнения I/O.

#### Threads (Многопоточность)

- Потоки — это системные единицы выполнения, создаваемые с помощью библиотеки threading.
- Потоки выполняются независимо друг от друга, но в CPython GIL (Global Interpreter Lock) не позволяет одновременно выполнять более одного байт-кода Python.
- Потоки полезны для ввода-вывода, но их эффективность ограничена для вычислительно-емких операций.

Пример:

```python
import threading
import time

def task1():
    print("Start task1")
    time.sleep(2)  # имитация I/O
    print("End task1")

def task2():
    print("Start task2")
    time.sleep(1)  # имитация I/O
    print("End task2")

thread1 = threading.Thread(target=task1)
thread2 = threading.Thread(target=task2)

thread1.start()
thread2.start()

thread1.join()
thread2.join()
```

Результат:

Потоки начинают выполнение одновременно, но переключение между ними управляется ОС.

### 3. Когда использовать asyncio, а когда потоки

**Используйте asyncio**:

- Если ваша программа в основном связана с операциями ввода-вывода (I/O-bound).Примеры: работа с сетью, API, базы данных.

- Если вы хотите низкие накладные расходы на управление задачами.
- Если ваш проект уже использует асинхронный подход или требует высокой масштабируемости.

**Используйте потоки**:

- Если нужно использовать существующие блокирующие библиотеки, которые не поддерживают асинхронность.
- Если вы работаете с кодом, который не может быть переписан на асинхронный синтаксис.
- Если вы хотите воспользоваться преимуществами параллельного выполнения задач, которые не зависят от GIL (например, с помощью concurrent.futures.ThreadPoolExecutor).

### 4. Когда не подходит ни asyncio, ни потоки

Для задач, которые зависят от интенсивного использования CPU (например, математические расчеты, обработка данных), лучше использовать многопроцессорность с библиотекой multiprocessing, которая обходит GIL.

### 5. Какую модель выбрать для высоконагруженных систем

Для веб-сервисов или приложений с большим количеством соединений (например, веб-сокеты или REST API):

- Используйте asyncio с асинхронными библиотеками (например, FastAPI).

Если необходимо обрабатывать вычислительно сложные задачи, лучше использовать:

- Многопроцессорность (multiprocessing).
- Или использовать потокобезопасные библиотеки (например, написанные на C или Go).

Если нужно комбинировать ввод-вывод с интенсивными вычислениями:

- Используйте asyncio для I/O и вынесите CPU-bound задачи в процессы.

## 3. Как использовать async и await в Python?

### Ключевые понятия

- async: используется для объявления корутин (асинхронных функций).

```python
async def fetch_data(): # Асинхронная функция
    pass
```

- await: указывает, что выполнение функции нужно приостановить, пока не завершится асинхронная операция.

```python
async def main():
    result = await fetch_data()
```

Пример:

```python
import asyncio

async def say_hello():
    await asyncio.sleep(1) # имитация асинхронной операции
    print("Hello, world!")

async def main():
    await say_hello()


# Запуск цикла событий
asyncio.run(main())
```
